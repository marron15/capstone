<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Access gym memberships, trainers, and services at RNR Fitness Gym.">
  <!-- Flutter manages viewport meta for optimal compatibility -->

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="RNR Fitness">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>RNR Fitness Gym</title>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <script>
    // Suppress Noto font warnings from Flutter
    (function() {
      const originalWarn = console.warn;
      console.warn = function(...args) {
        const message = args.join(' ');
        // Suppress Noto font related warnings
        if (message.includes('Noto fonts') || message.includes('missing characters')) {
          return; // Suppress this warning
        }
        // Call original warn for other messages
        originalWarn.apply(console, args);
      };
    })();

    (function () {
      const shouldLogIntlFix =
        ['localhost', '127.0.0.1', ''].includes(window.location.hostname);
      if (!window.Intl) return;
      const descriptor = Object.getOwnPropertyDescriptor(Intl, 'v8BreakIterator');
      if (!descriptor) return;
      try {
        if (descriptor.writable) {
          Intl.v8BreakIterator = undefined;
        } else if (descriptor.configurable) {
          Object.defineProperty(Intl, 'v8BreakIterator', {
            value: undefined,
            configurable: true,
            writable: true,
          });
        }
      } catch (err) {
        if (shouldLogIntlFix) {
          console.warn('Unable to redefine Intl.v8BreakIterator:', err);
        }
      }
    }());
  </script>
  <!-- PWA Install Prompt Handler -->
  <script>
    let deferredPwaPrompt;
    let isStandalone = false;
    let manifestLoaded = false;
    const shouldLogPwa =
      ['localhost', '127.0.0.1', ''].includes(window.location.hostname);
    const pwaLog = (...args) => {
      if (shouldLogPwa) {
        console.log(...args);
      }
    };
    const pwaWarn = (...args) => {
      if (shouldLogPwa) {
        console.warn(...args);
      }
    };
    
    // Check if app is already installed (standalone mode)
    if (window.matchMedia('(display-mode: standalone)').matches || 
        window.navigator.standalone === true ||
        document.referrer.includes('android-app://')) {
      isStandalone = true;
      pwaLog('PWA: App is already installed (standalone mode)');
    }

    // Check if manifest is accessible
    // Try multiple possible paths
    const manifestPaths = [
      'manifest.json',
      './manifest.json',
      '/manifest.json',
      window.location.pathname.replace(/\/[^/]*$/, '/manifest.json')
    ];
    
    let manifestCheckAttempts = 0;
    const checkManifest = (path) => {
      fetch(path)
        .then(response => {
          if (response.ok) {
            manifestLoaded = true;
            pwaLog('PWA: Manifest loaded successfully from', path);
            // Dispatch event to inform Flutter that manifest is available
            window.dispatchEvent(new CustomEvent('pwa-manifest-ready', { detail: true }));
          } else if (manifestCheckAttempts < manifestPaths.length - 1) {
            manifestCheckAttempts++;
            checkManifest(manifestPaths[manifestCheckAttempts]);
          }
        })
        .catch(error => {
          if (manifestCheckAttempts < manifestPaths.length - 1) {
            manifestCheckAttempts++;
            checkManifest(manifestPaths[manifestCheckAttempts]);
          } else {
            pwaWarn('PWA: Manifest check failed for all paths:', error);
          }
        });
    };
    
    checkManifest(manifestPaths[0]);

    // Listen for the beforeinstallprompt event
    window.addEventListener('beforeinstallprompt', (e) => {
      pwaLog('PWA: Install prompt available');
      // Prevent the default mini-infobar from appearing on mobile
      e.preventDefault();
      // Store the event so it can be triggered later
      deferredPwaPrompt = e;
      // Dispatch a custom event to inform Flutter
      window.dispatchEvent(new CustomEvent('pwa-installable', { detail: true }));
    });

    // Check if PWA install is available
    window.isPwaInstallAvailable = function() {
      // Don't show if already installed
      if (isStandalone) {
        return false;
      }
      
      // If beforeinstallprompt event fired, install is definitely available
      if (deferredPwaPrompt !== undefined) {
        return true;
      }
      
      // Fallback: Check if manifest is loaded and we're not in standalone mode
      // This allows the button to show even if beforeinstallprompt hasn't fired yet
      // The browser will show its own prompt if needed
      if (manifestLoaded && !isStandalone) {
        // Check if we're on a supported platform
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
        const isEdge = /Edg/.test(navigator.userAgent);
        const isSafari = /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor);
        
        // Show button on supported browsers
        if (isMobile || isChrome || isEdge || (isSafari && isMobile)) {
          return true;
        }
      }
      
      return false;
    };

    // Trigger the PWA install prompt
    window.triggerPwaInstall = async function() {
      if (isStandalone) {
        pwaLog('PWA: App is already installed');
        return false;
      }

      if (deferredPwaPrompt) {
        // Show the install prompt
        deferredPwaPrompt.prompt();
        
        // Wait for the user to respond to the prompt
        const { outcome } = await deferredPwaPrompt.userChoice;
        pwaLog('PWA: User response:', outcome);
        
        // Clear the deferred prompt as it can only be used once
        deferredPwaPrompt = null;
        
        // Dispatch event to inform Flutter
        window.dispatchEvent(new CustomEvent('pwa-install-result', { detail: outcome }));
        
        return outcome === 'accepted';
      } else {
        // Fallback: Try to show browser's native install prompt
        // This works for browsers that support it
        pwaLog('PWA: Using fallback install method');
        
        // For iOS Safari, show instructions
        if (/iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream) {
          alert('To install this app:\n1. Tap the Share button\n2. Select "Add to Home Screen"');
          return false;
        }
        
        // For other browsers, the manifest should trigger the install prompt
        // If it doesn't, we can't do much more
        return false;
      }
    };

    // Handle successful installation
    window.addEventListener('appinstalled', () => {
      pwaLog('PWA: App installed');
      isStandalone = true;
      deferredPwaPrompt = null;
      window.dispatchEvent(new CustomEvent('pwa-installed', { detail: true }));
    });

    // Periodic check for installability (in case beforeinstallprompt fires late)
    setInterval(() => {
      if (!isStandalone && manifestLoaded && !deferredPwaPrompt) {
        // Re-check availability periodically
        window.dispatchEvent(new CustomEvent('pwa-check-availability', { detail: true }));
      }
    }, 3000);

    // Show install button after a delay if manifest is loaded
    // This handles cases where beforeinstallprompt might not fire immediately
    setTimeout(() => {
      if (!isStandalone && manifestLoaded) {
        pwaLog('PWA: Manifest loaded, install should be available');
        // Force a check by dispatching an event
        window.dispatchEvent(new CustomEvent('pwa-manifest-ready', { detail: true }));
      }
    }, 2000);
  </script>

  <!-- Service worker is automatically handled by Flutter's flutter_bootstrap.js -->
  <!-- Note: Run patch_bootstrap.ps1 after building to disable service worker -->
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>
